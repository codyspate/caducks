---
import { actions } from "astro:actions";
import { drizzle } from "drizzle-orm/d1";
import * as schema from "../../../db/schema";
import Layout from "../../../layouts/Layout.astro";
import { getLocationBySlug } from "../../../lib/data";

const { slug } = Astro.params;
const {
    user,
    runtime: { env },
} = Astro.locals;

// 1. Authentication Check
if (!user) {
    return Astro.redirect(`/signin?redirect=${Astro.url.pathname}`);
}

if (!slug) {
    return Astro.redirect("/404");
}

const db = drizzle(env.DB, { schema });
const location = await getLocationBySlug(db, slug);

// 2. Check if location exists
if (!location) {
    return Astro.redirect("/404");
}

let errorMessage = "";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const intent = formData.get("intent");

    if (intent === "delete") {
        const result = await Astro.callAction(actions.locations.delete, {
            id: formData.get("id") as string,
        });
        console.log("Delete result:", JSON.stringify(result, null, 2));
        if (result?.error) {
            errorMessage = result.error.message || "Failed to delete location";
        } else if (result?.data?.success) {
            return Astro.redirect("/locations");
        }
    } else {
        const updateData = {
            id: formData.get("id") as string,
            name: formData.get("name") as string,
            content: formData.get("content") as string,
            description: (formData.get("description") as string) || undefined,
            contact_phone:
                (formData.get("contact_phone") as string) || undefined,
            contact_email:
                (formData.get("contact_email") as string) || undefined,
            contact_website:
                (formData.get("contact_website") as string) || undefined,
            latitude: (formData.get("latitude") as string) || undefined,
            longitude: (formData.get("longitude") as string) || undefined,
            isPublicLand: (formData.get("isPublicLand") as string) || undefined,
        };
        console.log("Update data:", JSON.stringify(updateData, null, 2));
        const result = await Astro.callAction(
            actions.locations.update,
            updateData,
        );
        console.log("Update result:", JSON.stringify(result, null, 2));
        if (result?.error) {
            errorMessage = result.error.message || "Failed to update location";
        } else if (result?.data?.success) {
            return Astro.redirect(`/locations/${result.data.slug}`);
        }
    }
}

// Any authenticated user can edit (wiki-style)
---

<Layout title={`Edit ${location.name} - California Ducks`}>
    <main class="mx-auto p-4 w-200 max-w-full text-neutral-200">
        <div class="mb-8">
            <a href={`/locations/${slug}`} class="link-accent"
                >&larr; Back to Location</a
            >
        </div>

        <h1
            class="text-4xl font-bold leading-tight mb-6 font-serif text-neutral-100"
        >
            Edit Location
        </h1>

        <div class="section-container">
            <form method="POST" id="edit-form" class="space-y-6">
                <input type="hidden" name="id" value={location.id} />
                <div>
                    <label for="name" class="form-label">Location Name</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        required
                        value={location.name}
                        class="input-field"
                    />
                </div>

                <div>
                    <label for="description" class="form-label"
                        >Short Description</label
                    >
                    <textarea
                        id="description"
                        name="description"
                        rows="2"
                        class="textarea-field font-sans"
                        set:text={location.description || ""}
                    />
                </div>

                <div>
                    <label for="content" class="form-label"
                        >Details (Markdown supported)</label
                    >
                    <textarea
                        id="content"
                        name="content"
                        rows="10"
                        required
                        class="textarea-field font-sans"
                        set:text={location.content}
                    />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="contact_phone" class="form-label"
                            >Contact Phone</label
                        >
                        <input
                            type="tel"
                            id="contact_phone"
                            name="contact_phone"
                            value={location.contact_phone || ""}
                            class="input-field"
                        />
                    </div>
                    <div>
                        <label for="contact_email" class="form-label"
                            >Contact Email</label
                        >
                        <input
                            type="email"
                            id="contact_email"
                            name="contact_email"
                            value={location.contact_email || ""}
                            class="input-field"
                        />
                    </div>
                </div>

                <div>
                    <label for="contact_website" class="form-label"
                        >Website</label
                    >
                    <input
                        type="url"
                        id="contact_website"
                        name="contact_website"
                        value={location.contact_website || ""}
                        class="input-field"
                    />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="latitude" class="form-label">Latitude</label
                        >
                        <input
                            type="number"
                            id="latitude"
                            name="latitude"
                            step="any"
                            min="-90"
                            max="90"
                            value={location.latitude ?? ""}
                            class="input-field"
                            placeholder="e.g., 38.1234"
                        />
                    </div>
                    <div>
                        <label for="longitude" class="form-label"
                            >Longitude</label
                        >
                        <input
                            type="number"
                            id="longitude"
                            name="longitude"
                            step="any"
                            min="-180"
                            max="180"
                            value={location.longitude ?? ""}
                            class="input-field"
                            placeholder="e.g., -121.5678"
                        />
                    </div>
                </div>
                <p class="text-sm text-neutral-400 -mt-4">
                    Tip: Find coordinates on Google Maps by right-clicking a
                    location.
                </p>

                <div>
                    <label for="isPublicLand" class="form-label"
                        >Land Access</label
                    >
                    <select
                        id="isPublicLand"
                        name="isPublicLand"
                        class="input-field"
                    >
                        <option
                            value=""
                            selected={location.isPublicLand === null}
                            >Unknown</option
                        >
                        <option
                            value="true"
                            selected={location.isPublicLand === true}
                            >Public Land</option
                        >
                        <option
                            value="false"
                            selected={location.isPublicLand === false}
                            >Private Land</option
                        >
                    </select>
                    <p class="text-sm text-neutral-400 mt-1">
                        Indicates whether the land is publicly accessible or
                        privately owned.
                    </p>
                </div>

                {
                    errorMessage && (
                        <div class="text-red-400 text-sm bg-red-900/20 p-3 rounded border border-red-800">
                            {errorMessage}
                        </div>
                    )
                }

                <div class="flex gap-4">
                    <button type="submit" id="submit-btn" class="btn-primary">
                        Save Changes
                    </button>
                    <a href={`/locations/${slug}`} class="btn-secondary">
                        Cancel
                    </a>
                </div>
            </form>

            <div class="mt-8 pt-6 border-t border-neutral-800">
                <h3 class="text-lg font-bold text-red-400 mb-3">Danger Zone</h3>
                <p class="text-sm text-neutral-400 mb-4">
                    Deleting this location cannot be undone.
                </p>
                <form method="POST" id="delete-form">
                    <input type="hidden" name="id" value={location.id} />
                    <input type="hidden" name="intent" value="delete" />
                    <button type="submit" id="delete-btn" class="btn-danger">
                        Delete Location
                    </button>
                </form>
            </div>
        </div>
    </main>
</Layout>

<script>
    document.addEventListener("astro:after-swap", () => {
        // Edit form submission
        const form = document.getElementById("edit-form") as HTMLFormElement;
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;
        const errorMessage = document.getElementById(
            "error-message",
        ) as HTMLDivElement;

        form?.addEventListener("submit", () => {
            errorMessage.classList.add("hidden");
            submitBtn.disabled = true;
            submitBtn.textContent = "Saving...";
        });

        // Delete button
        const deleteForm = document.getElementById(
            "delete-form",
        ) as HTMLFormElement;
        const deleteBtn = document.getElementById("delete-btn");

        deleteForm?.addEventListener("submit", (e) => {
            if (
                !confirm(
                    "Are you sure you want to delete this location? This cannot be undone.",
                )
            ) {
                e.preventDefault();
                return;
            }

            if (deleteBtn) {
                deleteBtn.textContent = "Deleting...";
                (deleteBtn as HTMLButtonElement).disabled = true;
            }
        });
    });
</script>
