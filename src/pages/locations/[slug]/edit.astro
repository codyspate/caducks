---
import { eq } from "drizzle-orm";
import { drizzle } from "drizzle-orm/d1";
import { nanoid } from "nanoid";
import * as schema from "../../../db/schema";
import Layout from "../../../layouts/Layout.astro";
import { getLocationBySlug } from "../../../lib/data";

const { slug } = Astro.params;
const {
    user,
    runtime: { env },
} = Astro.locals;

// 1. Authentication Check
if (!user) {
    return Astro.redirect(`/signin?redirect=${Astro.url.pathname}`);
}

if (!slug) {
    return Astro.redirect("/404");
}

const db = drizzle(env.DB, { schema });
const location = await getLocationBySlug(db, slug);

// 2. Check if location exists
if (!location) {
    return Astro.redirect("/404");
}

// 3. Authorization Check
if (location.userId !== user.id) {
    // User is not the owner, redirect them.
    return Astro.redirect(`/locations/${slug}`);
}

// 4. Handle POST request for form submission
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const name = formData.get("name") as string;
        const description = formData.get("description") as string;
        const newContent = formData.get("content") as string;
        const contact_phone = formData.get("contact_phone") as string;
        const contact_email = formData.get("contact_email") as string;
        const contact_website = formData.get("contact_website") as string;
        const latitudeStr = formData.get("latitude") as string;
        const longitudeStr = formData.get("longitude") as string;
        const latitude = latitudeStr ? parseFloat(latitudeStr) : null;
        const longitude = longitudeStr ? parseFloat(longitudeStr) : null;

        if (!name || !newContent) {
            throw new Error("Name and content are required.");
        }

        const now = new Date();
        const oldContent = location.content; // Capture old content for history

        // Update the location
        await db
            .update(schema.locations)
            .set({
                name,
                description,
                content: newContent,
                contact_phone,
                contact_email,
                contact_website,
                latitude,
                longitude,
                updatedAt: now,
            })
            .where(eq(schema.locations.id, location.id));

        // Record the edit in the history table
        if (oldContent !== newContent) {
            await db.insert(schema.location_edits).values({
                id: nanoid(),
                locationId: location.id,
                userId: user.id,
                oldContent: oldContent,
                newContent: newContent,
                editTimestamp: now,
            });
        }

        return Astro.redirect(`/locations/${slug}`);
    } catch (error) {
        console.error("Failed to update location:", error);
        // Handle error, maybe show a message to the user
    }
}
---

<Layout title={`Edit ${location.name} - California Ducks`}>
    <main class="mx-auto p-4 w-200 max-w-full text-neutral-200">
        <div class="mb-8">
            <a href={`/locations/${slug}`} class="link-accent"
                >&larr; Back to Location</a
            >
        </div>

        <h1
            class="text-4xl font-bold leading-tight mb-6 font-serif text-neutral-100"
        >
            Edit Location
        </h1>

        <div class="section-container">
            <form method="POST" class="space-y-6">
                <div>
                    <label for="name" class="form-label">Location Name</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        required
                        value={location.name}
                        class="input-field"
                    />
                </div>

                <div>
                    <label for="description" class="form-label"
                        >Short Description</label
                    >
                    <textarea
                        id="description"
                        name="description"
                        rows="2"
                        class="textarea-field font-sans"
                        >{location.description}</textarea
                    >
                </div>

                <div>
                    <label for="content" class="form-label"
                        >Details (Markdown supported)</label
                    >
                    <textarea
                        id="content"
                        name="content"
                        rows="10"
                        required
                        class="textarea-field font-sans"
                        >{location.content}</textarea
                    >
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="contact_phone" class="form-label"
                            >Contact Phone</label
                        >
                        <input
                            type="tel"
                            id="contact_phone"
                            name="contact_phone"
                            value={location.contact_phone || ""}
                            class="input-field"
                        />
                    </div>
                    <div>
                        <label for="contact_email" class="form-label"
                            >Contact Email</label
                        >
                        <input
                            type="email"
                            id="contact_email"
                            name="contact_email"
                            value={location.contact_email || ""}
                            class="input-field"
                        />
                    </div>
                </div>

                <div>
                    <label for="contact_website" class="form-label"
                        >Website</label
                    >
                    <input
                        type="url"
                        id="contact_website"
                        name="contact_website"
                        value={location.contact_website || ""}
                        class="input-field"
                    />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="latitude" class="form-label">Latitude</label
                        >
                        <input
                            type="number"
                            id="latitude"
                            name="latitude"
                            step="any"
                            min="-90"
                            max="90"
                            value={location.latitude ?? ""}
                            class="input-field"
                            placeholder="e.g., 38.1234"
                        />
                    </div>
                    <div>
                        <label for="longitude" class="form-label"
                            >Longitude</label
                        >
                        <input
                            type="number"
                            id="longitude"
                            name="longitude"
                            step="any"
                            min="-180"
                            max="180"
                            value={location.longitude ?? ""}
                            class="input-field"
                            placeholder="e.g., -121.5678"
                        />
                    </div>
                </div>
                <p class="text-sm text-neutral-400 -mt-4">
                    Tip: Find coordinates on Google Maps by right-clicking a
                    location.
                </p>

                <div class="flex gap-4">
                    <button type="submit" class="btn-primary">
                        Save Changes
                    </button>
                    <a href={`/locations/${slug}`} class="btn-secondary">
                        Cancel
                    </a>
                </div>
            </form>

            <div class="mt-8 pt-6 border-t border-neutral-800">
                <h3 class="text-lg font-bold text-red-400 mb-3">Danger Zone</h3>
                <p class="text-sm text-neutral-400 mb-4">
                    Deleting this location cannot be undone.
                </p>
                <button
                    type="button"
                    id="delete-btn"
                    data-location-id={location.id}
                    class="btn-danger"
                >
                    Delete Location
                </button>
            </div>
        </div>
    </main>
</Layout>

<script>
    const deleteBtn = document.getElementById("delete-btn");
    deleteBtn?.addEventListener("click", async () => {
        const locationId = deleteBtn.getAttribute("data-location-id");
        if (
            !confirm(
                "Are you sure you want to delete this location? This cannot be undone.",
            )
        ) {
            return;
        }

        deleteBtn.textContent = "Deleting...";
        (deleteBtn as HTMLButtonElement).disabled = true;

        try {
            const response = await fetch(`/api/locations/${locationId}`, {
                method: "DELETE",
            });

            if (response.ok) {
                window.location.href = "/locations";
            } else {
                const data = await response.json();
                alert(data.error || "Failed to delete");
                deleteBtn.textContent = "Delete Location";
                (deleteBtn as HTMLButtonElement).disabled = false;
            }
        } catch (error) {
            alert("An error occurred");
            deleteBtn.textContent = "Delete Location";
            (deleteBtn as HTMLButtonElement).disabled = false;
        }
    });
</script>
