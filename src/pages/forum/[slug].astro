---
import { eq } from "drizzle-orm";
import { drizzle } from "drizzle-orm/d1";
import { nanoid } from "nanoid";
import ForumVote from "../../components/ForumVote";
import * as schema from "../../db/schema";
import Layout from "../../layouts/Layout.astro";
import { getTopicBySlug, getUserVotesForTopic } from "../../lib/data";

const {
    user,
    runtime: { env },
} = Astro.locals;
const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

const db = drizzle(env.DB, { schema });

// Handle POST for new replies
if (Astro.request.method === "POST" && user) {
    try {
        const formData = await Astro.request.formData();
        const content = formData.get("content") as string;

        if (!content) {
            throw new Error("Content is required.");
        }

        // Get topic to get its ID
        const topic = await getTopicBySlug(db, slug);
        if (!topic?.id) {
            return Astro.redirect("/404");
        }

        const now = new Date();

        await db.insert(schema.forum_posts).values({
            id: nanoid(),
            content,
            userId: user.id,
            topicId: topic.id,
            voteCount: 0,
            createdAt: now,
            updatedAt: now,
        });

        // Update topic's updatedAt to bump it in the list
        await db
            .update(schema.forum_topics)
            .set({ updatedAt: now })
            .where(eq(schema.forum_topics.id, topic.id));

        return Astro.redirect(`/forum/${slug}`);
    } catch (error) {
        console.error("Failed to create reply:", error);
    }
}

const topic = await getTopicBySlug(db, slug);

if (!topic) {
    return Astro.redirect("/404");
}

// Get user's votes for this topic and its posts
let userVotes = new Map<string, number>();
if (user && topic.id) {
    const postIds = topic.posts?.map((p) => p.id) ?? [];
    userVotes = await getUserVotesForTopic(db, user.id, topic.id, postIds);
}

const topicUserVote = userVotes.get(`topic:${topic.id}`) ?? 0;
const isTopicOwner = user?.id === topic.userId;
---

<Layout title={`${topic.title} - California Ducks Forum`}>
    <main class="mx-auto p-4 w-200 max-w-full text-neutral-200">
        <div class="mb-8">
            <a href="/forum" class="link-accent">&larr; Back to Forum</a>
        </div>

        <article class="mb-12">
            <div class="mb-6">
                <div class="flex items-start gap-4">
                    <ForumVote
                        client:load
                        topicId={topic.id}
                        initialVoteCount={topic.voteCount ?? 0}
                        initialUserVote={topicUserVote}
                        isLoggedIn={!!user}
                    />
                    <div class="flex-1">
                        <h1
                            class="text-4xl font-bold leading-tight mb-2 font-serif"
                        >
                            {topic.title}
                        </h1>
                        <div
                            class="text-neutral-400 text-sm flex items-center gap-4"
                        >
                            <span>
                                Posted by <span class="text-amber-500 font-bold"
                                    >{topic.author}</span
                                > on {topic.createdAt}
                            </span>
                            {
                                isTopicOwner && (
                                    <a
                                        href={`/forum/${slug}/edit`}
                                        class="text-neutral-500 hover:text-amber-500 transition-colors"
                                    >
                                        Edit
                                    </a>
                                )
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="bg-neutral-900 p-6 rounded-lg border border-neutral-800 mb-4 border-l-4 border-l-amber-600 text-lg leading-relaxed shadow-lg"
            >
                <div class="whitespace-pre-wrap">
                    {topic.content}
                </div>
            </div>
        </article>

        <div class="mt-8">
            <h2
                class="text-2xl font-bold border-b border-neutral-800 pb-2 mb-6 text-neutral-200 font-serif"
            >
                Replies ({topic.posts?.length || 0})
            </h2>

            {
                topic.posts?.map((post) => {
                    const postUserVote = userVotes.get(`post:${post.id}`) ?? 0;
                    const isPostOwner = user?.id === post.userId;
                    return (
                        <div class="bg-neutral-900 p-6 rounded-lg border border-neutral-800 mb-4 transition-transform hover:-translate-y-0.5 shadow-md">
                            <div class="flex gap-4">
                                <ForumVote
                                    client:load
                                    postId={post.id}
                                    initialVoteCount={post.voteCount ?? 0}
                                    initialUserVote={postUserVote}
                                    isLoggedIn={!!user}
                                />
                                <div class="flex-1">
                                    <div class="flex justify-between mb-3 text-sm text-neutral-500 border-b border-neutral-800 pb-2">
                                        <span class="text-amber-500 font-bold">
                                            {post.author}
                                        </span>
                                        <div class="flex items-center gap-4">
                                            <span class="text-neutral-500">
                                                {post.createdAt}
                                            </span>
                                            {isPostOwner && (
                                                <a
                                                    href={`/forum/${slug}/post/${post.id}/edit`}
                                                    class="text-neutral-500 hover:text-amber-500 transition-colors"
                                                >
                                                    Edit
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                    <div class="text-neutral-300 leading-relaxed whitespace-pre-wrap">
                                        {post.content}
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                })
            }

            <div
                class="mt-12 bg-neutral-900 p-6 rounded-lg border border-neutral-800"
            >
                {
                    user ? (
                        <form method="POST">
                            <h3 class="text-xl font-bold mb-4 mt-0 font-serif">
                                Leave a Reply
                            </h3>
                            <textarea
                                name="content"
                                placeholder="Write your reply here..."
                                rows="4"
                                required
                                class="textarea-field font-sans mb-4"
                            />
                            <button type="submit" class="btn-primary">
                                Post Reply
                            </button>
                        </form>
                    ) : (
                        <div class="text-center text-neutral-400">
                            <p class="mb-4">
                                You must be logged in to post a reply.
                            </p>
                            <a
                                href={`/signin?redirect=${Astro.url.pathname}`}
                                class="btn-primary py-2 px-5"
                            >
                                Sign In to Reply
                            </a>
                        </div>
                    )
                }
            </div>
        </div>
    </main>
</Layout>
