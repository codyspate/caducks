---
import { eq } from "drizzle-orm";
import { drizzle } from "drizzle-orm/d1";
import * as schema from "../../../db/schema";
import Layout from "../../../layouts/Layout.astro";
import { getTopicBySlug } from "../../../lib/data";

const { slug } = Astro.params;
const {
    user,
    runtime: { env },
} = Astro.locals;

if (!user) {
    return Astro.redirect(`/signin?redirect=${Astro.url.pathname}`);
}

if (!slug) {
    return Astro.redirect("/404");
}

const db = drizzle(env.DB, { schema });
const topic = await getTopicBySlug(db, slug);

if (!topic) {
    return Astro.redirect("/404");
}

// Check ownership
if (topic.userId !== user.id) {
    return Astro.redirect(`/forum/${slug}`);
}

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const title = formData.get("title") as string;
        const content = formData.get("content") as string;

        if (!title || !content) {
            throw new Error("Title and content are required.");
        }

        if (topic.id) {
            await db
                .update(schema.forum_topics)
                .set({
                    title,
                    content,
                    updatedAt: new Date(),
                })
                .where(eq(schema.forum_topics.id, topic.id));
        }

        return Astro.redirect(`/forum/${slug}`);
    } catch (error) {
        console.error("Failed to update topic:", error);
    }
}
---

<Layout title={`Edit: ${topic.title} - California Ducks Forum`}>
    <main class="mx-auto p-4 w-200 max-w-full text-neutral-200">
        <div class="mb-8">
            <a href={`/forum/${slug}`} class="link-accent"
                >&larr; Back to Topic</a
            >
        </div>

        <h1
            class="text-4xl font-bold leading-tight mb-6 font-serif text-neutral-100"
        >
            Edit Discussion
        </h1>

        <div class="section-container">
            <form method="POST" class="space-y-6">
                <div>
                    <label for="title" class="form-label"
                        >Discussion Title</label
                    >
                    <input
                        type="text"
                        id="title"
                        name="title"
                        required
                        minlength="5"
                        value={topic.title}
                        class="input-field"
                    />
                </div>
                <div>
                    <label for="content" class="form-label">Your Message</label>
                    <textarea
                        id="content"
                        name="content"
                        rows="8"
                        required
                        minlength="10"
                        class="textarea-field font-sans"
                        >{topic.content}</textarea
                    >
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="btn-primary">
                        Save Changes
                    </button>
                    <a href={`/forum/${slug}`} class="btn-secondary">
                        Cancel
                    </a>
                </div>
            </form>

            <div class="mt-8 pt-6 border-t border-neutral-800">
                <h3 class="text-lg font-bold text-red-400 mb-3">Danger Zone</h3>
                <p class="text-sm text-neutral-400 mb-4">
                    Deleting this discussion will also remove all replies. This
                    action cannot be undone.
                </p>
                <button
                    type="button"
                    id="delete-btn"
                    data-topic-id={topic.id}
                    class="btn-danger"
                >
                    Delete Discussion
                </button>
            </div>
        </div>
    </main>
</Layout>

<script>
    const deleteBtn = document.getElementById("delete-btn");
    deleteBtn?.addEventListener("click", async () => {
        const topicId = deleteBtn.getAttribute("data-topic-id");
        if (
            !confirm(
                "Are you sure you want to delete this discussion? This cannot be undone.",
            )
        ) {
            return;
        }

        deleteBtn.textContent = "Deleting...";
        (deleteBtn as HTMLButtonElement).disabled = true;

        try {
            const response = await fetch(`/api/forum/topic/${topicId}`, {
                method: "DELETE",
            });

            if (response.ok) {
                window.location.href = "/forum";
            } else {
                const data = await response.json();
                alert(data.error || "Failed to delete");
                deleteBtn.textContent = "Delete Discussion";
                (deleteBtn as HTMLButtonElement).disabled = false;
            }
        } catch (error) {
            alert("An error occurred");
            deleteBtn.textContent = "Delete Discussion";
            (deleteBtn as HTMLButtonElement).disabled = false;
        }
    });
</script>
