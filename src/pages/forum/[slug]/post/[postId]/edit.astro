---
import { eq } from "drizzle-orm";
import { drizzle } from "drizzle-orm/d1";
import * as schema from "../../../../../db/schema";
import Layout from "../../../../../layouts/Layout.astro";

const { slug, postId } = Astro.params;
const {
    user,
    runtime: { env },
} = Astro.locals;

if (!user) {
    return Astro.redirect(`/signin?redirect=${Astro.url.pathname}`);
}

if (!slug || !postId) {
    return Astro.redirect("/404");
}

const db = drizzle(env.DB, { schema });

// Get the post
const postResult = await db
    .select()
    .from(schema.forum_posts)
    .where(eq(schema.forum_posts.id, postId))
    .limit(1);

const post = postResult[0];

if (!post) {
    return Astro.redirect("/404");
}

// Check ownership
if (post.userId !== user.id) {
    return Astro.redirect(`/forum/${slug}`);
}

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const content = formData.get("content") as string;

        if (!content) {
            throw new Error("Content is required.");
        }

        await db
            .update(schema.forum_posts)
            .set({
                content,
                updatedAt: new Date(),
            })
            .where(eq(schema.forum_posts.id, postId));

        return Astro.redirect(`/forum/${slug}`);
    } catch (error) {
        console.error("Failed to update post:", error);
    }
}
---

<Layout title="Edit Reply - California Ducks Forum">
    <main class="mx-auto p-4 w-200 max-w-full text-neutral-200">
        <div class="mb-8">
            <a href={`/forum/${slug}`} class="link-accent"
                >&larr; Back to Topic</a
            >
        </div>

        <h1
            class="text-4xl font-bold leading-tight mb-6 font-serif text-neutral-100"
        >
            Edit Reply
        </h1>

        <div class="section-container">
            <form method="POST" class="space-y-6">
                <div>
                    <label for="content" class="form-label">Your Reply</label>
                    <textarea
                        id="content"
                        name="content"
                        rows="8"
                        required
                        minlength="10"
                        class="textarea-field font-sans"
                        >{post.content}</textarea
                    >
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="btn-primary">
                        Save Changes
                    </button>
                    <a href={`/forum/${slug}`} class="btn-secondary">
                        Cancel
                    </a>
                </div>
            </form>

            <div class="mt-8 pt-6 border-t border-neutral-800">
                <h3 class="text-lg font-bold text-red-400 mb-3">Danger Zone</h3>
                <p class="text-sm text-neutral-400 mb-4">
                    Deleting this reply cannot be undone.
                </p>
                <button
                    type="button"
                    id="delete-btn"
                    data-post-id={postId}
                    data-slug={slug}
                    class="btn-danger"
                >
                    Delete Reply
                </button>
            </div>
        </div>
    </main>
</Layout>

<script>
    const deleteBtn = document.getElementById("delete-btn");
    deleteBtn?.addEventListener("click", async () => {
        const postId = deleteBtn.getAttribute("data-post-id");
        const slug = deleteBtn.getAttribute("data-slug");
        if (
            !confirm(
                "Are you sure you want to delete this reply? This cannot be undone.",
            )
        ) {
            return;
        }

        deleteBtn.textContent = "Deleting...";
        (deleteBtn as HTMLButtonElement).disabled = true;

        try {
            const response = await fetch(`/api/forum/post/${postId}`, {
                method: "DELETE",
            });

            if (response.ok) {
                window.location.href = `/forum/${slug}`;
            } else {
                const data = await response.json();
                alert(data.error || "Failed to delete");
                deleteBtn.textContent = "Delete Reply";
                (deleteBtn as HTMLButtonElement).disabled = false;
            }
        } catch (error) {
            alert("An error occurred");
            deleteBtn.textContent = "Delete Reply";
            (deleteBtn as HTMLButtonElement).disabled = false;
        }
    });
</script>
