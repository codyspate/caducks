---
import { actions } from "astro:actions";
import Layout from "../../layouts/Layout.astro";

const { user } = Astro.locals;

if (!user) {
    return Astro.redirect(`/signin?redirect=${Astro.url.pathname}`);
}

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const result = await Astro.callAction(actions.forum.createTopic, {
        title: formData.get("title") as string,
        content: formData.get("content") as string,
    });
    if (result.data?.success) {
        return Astro.redirect(`/forum/${result.data.slug}`);
    }
}
---

<Layout title="Start a New Discussion - California Ducks">
    <main class="mx-auto p-4 w-200 max-w-full text-neutral-200">
        <div class="mb-8">
            <a href="/forum" class="link-accent">&larr; Back to Forum</a>
        </div>

        <h1
            class="text-4xl font-bold leading-tight mb-6 font-serif text-neutral-100"
        >
            Start a New Discussion
        </h1>

        <div class="section-container">
            <form id="create-form" method="POST" class="space-y-6">
                <div>
                    <label for="title" class="form-label"
                        >Discussion Title</label
                    >
                    <input
                        type="text"
                        id="title"
                        name="title"
                        required
                        minlength="5"
                        class="input-field"
                        placeholder="e.g., Best decoys for late season?"
                    />
                </div>
                <div>
                    <label for="content" class="form-label">Your Message</label>
                    <textarea
                        id="content"
                        name="content"
                        rows="8"
                        required
                        minlength="10"
                        class="textarea-field font-sans"
                        placeholder="Share your thoughts, tips, or questions..."
                    ></textarea>
                </div>
                <div>
                    <button
                        type="submit"
                        id="submit-btn"
                        class="w-full md:w-auto btn-primary"
                    >
                        Post Discussion
                    </button>
                </div>
            </form>
        </div>
    </main>
</Layout>

<script>
    document.addEventListener("astro:after-swap", () => {
        const form = document.getElementById("create-form");
        const submitBtn = document.getElementById("submit-btn");
        form?.addEventListener("submit", () => {
            if (submitBtn) {
                submitBtn.textContent = "Posting...";
                (submitBtn as HTMLButtonElement).disabled = true;
            }
        });
    });
</script>
