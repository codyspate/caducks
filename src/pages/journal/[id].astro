---
import { drizzle } from "drizzle-orm/d1";
import * as schema from "../../db/schema";
import Layout from "../../layouts/Layout.astro";
import { getJournalEntryById } from "../../lib/data";

const { user } = Astro.locals;
const { id } = Astro.params;

// This page is protected. Redirect to sign-in if the user is not logged in.
if (!user) {
    return Astro.redirect(`/signin?redirect=${Astro.url.pathname}`);
}

if (!id) {
    return Astro.redirect("/journal");
}

const db = drizzle(Astro.locals.runtime.env.DB, { schema });
const entry = await getJournalEntryById(db, id);

if (!entry) {
    return Astro.redirect("/journal");
}

// Check if user owns this entry
const isOwner = user.id === entry.userId;

if (!isOwner) {
    return Astro.redirect("/journal");
}

const huntDate = new Date(entry.huntDate);
const formattedDate = huntDate.toLocaleDateString("en-US", {
    weekday: "long",
    month: "long",
    day: "numeric",
    year: "numeric",
});
---

<Layout title={`Journal Entry - ${formattedDate} - California Ducks`}>
    <main class="mx-auto p-4 w-200 max-w-full text-neutral-200">
        <div class="mb-8">
            <a href="/journal" class="link-accent">&larr; Back to Journal</a>
        </div>

        <article class="section-container">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1
                        class="text-4xl font-bold leading-tight font-serif text-neutral-100 mb-2"
                    >
                        {formattedDate}
                    </h1>
                    <p class="text-neutral-400">
                        By {entry.author}
                    </p>
                </div>
                {
                    isOwner && (
                        <div class="flex gap-2">
                            <a
                                href={`/journal/${id}/edit`}
                                class="btn-secondary"
                            >
                                Edit
                            </a>
                            <button
                                id="delete-btn"
                                class="btn-secondary text-red-400 hover:text-red-300"
                            >
                                Delete
                            </button>
                        </div>
                    )
                }
            </div>

            <div class="space-y-4 mb-6">
                <div class="flex gap-6 text-neutral-300">
                    <div>
                        <span class="text-neutral-500">Hunters:</span>
                        <span class="font-semibold ml-2">{entry.numHunters}</span
                        >
                    </div>
                    <div>
                        <span class="text-neutral-500">Location:</span>
                        <span class="text-amber-500 ml-2"
                            >{entry.locationName || "Unknown"}</span
                        >
                    </div>
                </div>
            </div>

            {
                entry.harvests && entry.harvests.length > 0 && (
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-3 text-neutral-100">
                            Harvest
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {entry.harvests.map((harvest) => (
                                <div class="bg-neutral-800 p-4 rounded-lg flex justify-between items-center">
                                    <span class="text-neutral-200">
                                        {harvest.birdType}
                                    </span>
                                    <span class="text-amber-500 font-bold text-xl">
                                        {harvest.count}
                                    </span>
                                </div>
                            ))}
                        </div>
                        <div class="mt-3 text-right">
                            <span class="text-neutral-400">Total: </span>
                            <span class="text-amber-500 font-bold text-xl">
                                {entry.harvests.reduce(
                                    (sum, h) => sum + h.count,
                                    0,
                                )}{" "}
                                birds
                            </span>
                        </div>
                    </div>
                )
            }

            {
                entry.notes && (
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-3 text-neutral-100">
                            Notes
                        </h2>
                        <div class="prose prose-invert max-w-none">
                            <p class="text-neutral-300 whitespace-pre-wrap">
                                {entry.notes}
                            </p>
                        </div>
                    </div>
                )
            }

            <div class="text-sm text-neutral-500 mt-8 pt-6 border-t border-neutral-700">
                Created on {
                    new Date(entry.createdAt).toLocaleDateString("en-US", {
                        month: "long",
                        day: "numeric",
                        year: "numeric",
                    })
                }
                {
                    entry.updatedAt &&
                        new Date(entry.updatedAt).getTime() !==
                            new Date(entry.createdAt).getTime() && (
                            <>
                                {" "}
                                Â· Last updated on{" "}
                                {new Date(entry.updatedAt).toLocaleDateString(
                                    "en-US",
                                    {
                                        month: "long",
                                        day: "numeric",
                                        year: "numeric",
                                    },
                                )}
                            </>
                        )
                }
            </div>
        </article>
    </main>
</Layout>

<script>
    import { actions } from "astro:actions";

    document.getElementById("delete-btn")?.addEventListener("click", async () => {
        if (
            !confirm(
                "Are you sure you want to delete this journal entry? This action cannot be undone.",
            )
        ) {
            return;
        }

        const pathParts = window.location.pathname.split("/");
        const entryId = pathParts[pathParts.length - 1];

        try {
            const result = await actions.journals.delete({ id: entryId });

            if (result?.data?.success) {
                window.location.href = "/journal";
            } else {
                alert("Failed to delete entry. Please try again.");
            }
        } catch (error) {
            alert(
                `Error: ${error instanceof Error ? error.message : "Unknown error"}`,
            );
        }
    });
</script>
